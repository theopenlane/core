//go:build cli

package vulnerability

import (
	"context"

	"github.com/spf13/cobra"

	"github.com/theopenlane/core/cli/cmd"
	"github.com/theopenlane/go-client/graphclient"
)

var createCmd = &cobra.Command{
	Use:   "create",
	Short: "create a new vulnerability",
	Run: func(cmd *cobra.Command, args []string) {
		err := create(cmd.Context())
		cobra.CheckErr(err)
	},
}

func init() {
	command.AddCommand(createCmd)

	createCmd.Flags().StringP("external-id", "e", "", "external identifier from the integration source")
	createCmd.Flags().StringP("display-name", "n", "", "display name for the vulnerability")
	createCmd.Flags().StringP("cve-id", "c", "", "CVE identifier for the vulnerability")
	createCmd.Flags().StringP("category", "a", "", "category of the vulnerability")
	createCmd.Flags().StringP("severity", "s", "", "severity label (e.g. LOW, MEDIUM, HIGH, CRITICAL)")
	createCmd.Flags().StringP("source", "o", "", "system that produced the vulnerability record")
}

// createValidation validates the required fields for the command
func createValidation() (input graphclient.CreateVulnerabilityInput, err error) {
	input.ExternalID = cmd.Config.String("external-id")
	if input.ExternalID == "" {
		return input, cmd.NewRequiredFieldMissingError("external-id")
	}

	displayName := cmd.Config.String("display-name")
	if displayName != "" {
		input.DisplayName = &displayName
	}

	cveID := cmd.Config.String("cve-id")
	if cveID != "" {
		input.CveID = &cveID
	}

	category := cmd.Config.String("category")
	if category != "" {
		input.Category = &category
	}

	severity := cmd.Config.String("severity")
	if severity != "" {
		input.Severity = &severity
	}

	source := cmd.Config.String("source")
	if source != "" {
		input.Source = &source
	}

	return input, nil
}

// create a new vulnerability
func create(ctx context.Context) error {
	// attempt to setup with token, otherwise fall back to JWT with session
	client, err := cmd.TokenAuth(ctx, cmd.Config)
	if err != nil || client == nil {
		// setup http client
		client, err = cmd.SetupClientWithAuth(ctx)
		cobra.CheckErr(err)
		defer cmd.StoreSessionCookies(client)
	}

	input, err := createValidation()
	cobra.CheckErr(err)

	o, err := client.CreateVulnerability(ctx, input)
	cobra.CheckErr(err)

	return consoleOutput(o)
}
