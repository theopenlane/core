//go:build cli

package vulnerability

import (
	"context"

	"github.com/spf13/cobra"

	"github.com/theopenlane/core/cli/cmd"
	"github.com/theopenlane/go-client/graphclient"
)

var updateCmd = &cobra.Command{
	Use:   "update",
	Short: "update an existing vulnerability",
	Run: func(cmd *cobra.Command, args []string) {
		err := update(cmd.Context())
		cobra.CheckErr(err)
	},
}

func init() {
	command.AddCommand(updateCmd)

	updateCmd.Flags().StringP("id", "i", "", "vulnerability id to update")
	updateCmd.Flags().StringP("display-name", "n", "", "display name for the vulnerability")
	updateCmd.Flags().StringP("cve-id", "c", "", "CVE identifier for the vulnerability")
	updateCmd.Flags().StringP("category", "a", "", "category of the vulnerability")
	updateCmd.Flags().StringP("severity", "s", "", "severity label (e.g. LOW, MEDIUM, HIGH, CRITICAL)")
	updateCmd.Flags().StringP("source", "o", "", "system that produced the vulnerability record")
	updateCmd.Flags().StringP("add-finding-ids", "", "", "comma-separated list of finding IDs to add")
	updateCmd.Flags().StringP("add-remediation-ids", "", "", "comma-separated list of remediation IDs to add")
}

// updateValidation validates the required fields for the command
func updateValidation() (id string, input graphclient.UpdateVulnerabilityInput, err error) {
	id = cmd.Config.String("id")
	if id == "" {
		return id, input, cmd.NewRequiredFieldMissingError("vulnerability id")
	}

	displayName := cmd.Config.String("display-name")
	if displayName != "" {
		input.DisplayName = &displayName
	}

	cveID := cmd.Config.String("cve-id")
	if cveID != "" {
		input.CveID = &cveID
	}

	category := cmd.Config.String("category")
	if category != "" {
		input.Category = &category
	}

	severity := cmd.Config.String("severity")
	if severity != "" {
		input.Severity = &severity
	}

	source := cmd.Config.String("source")
	if source != "" {
		input.Source = &source
	}

	addFindingIDs := cmd.Config.String("add-finding-ids")
	if addFindingIDs != "" {
		input.AddFindingIDs = cmd.ParseIDList(addFindingIDs)
	}

	addRemediationIDs := cmd.Config.String("add-remediation-ids")
	if addRemediationIDs != "" {
		input.AddRemediationIDs = cmd.ParseIDList(addRemediationIDs)
	}

	return id, input, nil
}

// update an existing vulnerability in the platform
func update(ctx context.Context) error {
	// attempt to setup with token, otherwise fall back to JWT with session
	client, err := cmd.TokenAuth(ctx, cmd.Config)
	if err != nil || client == nil {
		// setup http client
		client, err = cmd.SetupClientWithAuth(ctx)
		cobra.CheckErr(err)
		defer cmd.StoreSessionCookies(client)
	}

	id, input, err := updateValidation()
	cobra.CheckErr(err)

	o, err := client.UpdateVulnerability(ctx, id, input)
	cobra.CheckErr(err)

	return consoleOutput(o)
}
