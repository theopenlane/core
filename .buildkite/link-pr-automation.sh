#!/bin/bash
set -euo pipefail

#
# EXECUTION CONTEXT: Docker container (with git, gh, docker, jq, buildkite-agent)
# REQUIRED TOOLS: gh
# ASSUMPTIONS: GitHub token available
#

# PR linking automation
# Adds comments to core PR linking to draft infra PR and vice versa

# Install gh if not available
if ! command -v gh >/dev/null 2>&1; then
    echo "Installing gh..."
    apk add --no-cache github-cli
fi

echo "=== PR Linking Automation ==="

# Check if we're in a PR context
if [[ -z "${BUILDKITE_PULL_REQUEST:-}" || "${BUILDKITE_PULL_REQUEST}" == "false" ]]; then
  echo "‚ÑπÔ∏è  Not running in PR context, skipping PR linking"
  exit 0
fi

# Check if draft PR metadata exists
if [[ ! -f "${BUILDKITE_BUILD_CHECKOUT_PATH}/.draft_pr_metadata" ]]; then
  echo "‚ÑπÔ∏è  No draft PR metadata found, skipping PR linking"
  exit 0
fi

# Load draft PR metadata
source "${BUILDKITE_BUILD_CHECKOUT_PATH}/.draft_pr_metadata"

echo "Core PR: #${BUILDKITE_PULL_REQUEST}"
echo "Draft Infra PR: ${DRAFT_PR_URL}"

# Note: We don't send Slack notifications for draft PRs to avoid being too chatty
# Notifications are only sent when PRs are ready for actual review/merge

# Add comment to core PR linking to draft infra PR
echo "üí¨ Adding comment to core PR #${BUILDKITE_PULL_REQUEST}..."

core_pr_comment="## üîó Related Infrastructure Changes

A draft PR has been automatically created in the infrastructure repository to show the configuration changes that will result from this PR:

**üöß Draft Infrastructure PR:** ${DRAFT_PR_URL}

### üìã Review Process
1. **Review both PRs together** - The draft PR shows exactly what configuration changes will be applied
2. **Merge this core PR first** - The infrastructure PR will automatically convert from draft to ready for review
3. **Review and merge the infrastructure PR** - Complete the deployment of configuration changes

### üîç What the Draft PR Shows
- Changes to Helm values.yaml (application configuration)
- Updates to External Secrets templates (secret management)
- Modifications to ConfigMap templates (non-sensitive configuration)

The draft PR preserves all existing Kubernetes-specific configurations while showing only the application configuration changes from this PR.

---
*This comment was automatically generated by the configuration change detection system.*"

# Add comment to core PR
if gh pr comment "${BUILDKITE_PULL_REQUEST}" --body "$core_pr_comment"; then
  echo "‚úÖ Comment added to core PR #${BUILDKITE_PULL_REQUEST}"
else
  echo "‚ö†Ô∏è  Failed to add comment to core PR #${BUILDKITE_PULL_REQUEST}"
fi

# Extract draft PR number from URL for commenting
draft_pr_number=$(echo "$DRAFT_PR_URL" | grep -o '[0-9]*$')

if [[ -n "$draft_pr_number" ]]; then
  echo "üí¨ Adding comment to draft infra PR #${draft_pr_number}..."

  # Get core PR URL
  core_pr_url="https://github.com/theopenlane/core/pull/${BUILDKITE_PULL_REQUEST}"

  infra_pr_comment="## üîó Related Core Changes

This draft PR shows configuration changes from the following core repository PR:

**üìù Source Core PR:** ${core_pr_url}

### ‚ö†Ô∏è Important Notes
- **This is a DRAFT PR** - Do not merge until the core PR is merged first
- **Review both PRs together** - This shows the configuration impact of the core changes
- **Auto-conversion** - This PR will automatically convert from draft to ready after core PR merge

### üìã Changes Overview
This PR contains the configuration updates that will be applied to the infrastructure repository based on changes in the core repository. All existing Kubernetes-specific configurations have been preserved.

### üîÑ Workflow Status
- [ ] Core PR under review: ${core_pr_url}
- [ ] Core PR merged
- [ ] This PR converted from draft to ready
- [ ] Infrastructure changes reviewed and merged

---
*This draft PR was automatically generated to provide visibility into configuration changes before they're finalized.*"

  # Add comment to draft infra PR (need to specify the repo)
  if gh pr comment "$draft_pr_number" --repo "$(echo "$DRAFT_PR_URL" | sed 's|/pull/.*||' | sed 's|.*github.com/||')" --body "$infra_pr_comment"; then
    echo "‚úÖ Comment added to draft infra PR #${draft_pr_number}"
  else
    echo "‚ö†Ô∏è  Failed to add comment to draft infra PR #${draft_pr_number}"
  fi
else
  echo "‚ö†Ô∏è  Could not extract PR number from draft PR URL: $DRAFT_PR_URL"
fi

# Note: No Slack notification sent for draft PR creation to reduce noise
# Notifications will be sent when the PR is ready for actual review

echo "üéâ PR linking completed successfully"