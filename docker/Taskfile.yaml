version: "3"

tasks:
  build:
    dir: ..
    desc: builds the core docker image
    cmds:
      - task: :go:build
        vars:
          GOOS: 'GOOS=linux'
          GOARCH: 'GOARCH=amd64'
      - "docker build -f docker/Dockerfile . -t core:dev"

  build:aio:
    dir: ..
    desc: builds the core docker image all-in-one image
    cmds:
      - "docker build -f ./docker/all-in-one/Dockerfile.all-in-one -t core:dev-aio ."

  core:local:
    aliases: ['core:up']
    dir: ..
    desc: brings up the compose environment for the core server
    deps: [build]
    cmds:
      - "docker compose -f ./docker/docker-compose-redis.yml -f ./docker/docker-compose-fga.yml -f ./docker/docker-compose-riverboat.yml -f ./docker/docker-compose.yml -p core up -d"

  core:local:down:
    aliases: ['core:down']
    dir: ..
    desc: brings the core compose environment down
    cmds:
      - "docker compose -p core down"

  core:published:
    dir: ..
    desc: brings up the compose environment for the core server using the published docker image. currently this will only work on x86 machines as its built using an x86 server
    cmds:
      - "docker compose -f ./docker/docker-compose-redis.yml -f ./docker/docker-compose-fga.yml -f ./docker/docker-compose-riverboat.yml -f ./docker/docker-compose-published.yml -p core up -d"

  core:published:down:
    dir: ..
    desc: brings the core compose environment down
    cmds:
      - "docker compose -p core down"

  all:local:up:
    aliases: ['all:up']
    dir: ..
    desc: brings up the full docker compose development environment including core server, fga, and rover
    cmds:
      - task: core
      - task: :rover

  all:local:down:
    aliases: ['all:down']
    dir: ..
    desc: brings down both fga and core server compose environments
    cmds:
      - task: core:down

  all:published:up:
    dir: ..
    desc: brings up the full docker compose development environment including core server, fga, and rover
    cmds:
      - task: core:published
      - task: :rover

  all:published:down:
    dir: ..
    desc: brings down both fga and core server compose environments
    cmds:
      - task: core:published:down

  redis:
    dir: ..
    desc: brings up the compose environment for redis
    cmds:
      - "docker compose -f ./docker/docker-compose-redis.yml -p redis up -d"

  redis:down:
    dir: ..
    desc: brings up the compose environment for redis
    cmds:
      - "docker compose -p redis down"

  riverboat:
    dir: ..
    desc: brings up the compose environment for riverboat
    env:
      RIVERBOAT_TAG: "{{.RIVERBOAT_TAG}}"
    vars:
      RIVERBOAT_TAG:
        sh: "uname=$(uname -m); if [ $uname = 'x86_64' ]; then echo 'amd64-latest'; else echo 'arm64-latest'; fi"
    cmds:
      - "docker compose -f ./docker/docker-compose-riverboat.yml -p riverboat up -d"

  riverboat:down:
    dir: ..
    desc: brings the riverboat compose environment down
    cmds:
      - docker compose -p riverboat down

  postgres:
    dir: ..
    desc: brings up the compose environment for postgres development
    cmds:
      - "docker compose -f ./docker/docker-compose-pg.yml -p postgres up -d"

  postgres:down:
    dir: ..
    desc: brings the postgres compose environment down
    cmds:
      - docker compose -p postgres down

  fga:
    dir: ..
    desc: brings up the compose environment for openfga development
    cmds:
      - "docker compose -f ./docker/docker-compose-fga.yml -p fga up -d"

  fga:down:
    dir: ..
    desc: brings the fga compose environment down
    cmds:
      - docker compose -p fga down

  fga:open:
    dir: ..
    desc: opens the fga playground in a browser
    cmds:
      - 'open "http://localhost:3000/playground"'

  fga:up:
    dir: ..
    desc: brings the fga compose environment up and opens the fga playground
    aliases: [fgaup]
    cmds:
      - task: fga
      - task: fga:open

  kafka:
    dir: ..
    desc: brings up the compose environment for kafka
    cmds:
      - "docker compose -f ./docker/docker-compose-kafka.yml -p kafka up --build -d"

  kafka:down:
    dir: ..
    desc: brings the kafka compose environment down
    cmds:
      - docker compose -p kafka down
