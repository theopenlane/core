// Code generated by ent, DO NOT EDIT.

package generated

import (
	"context"

	"github.com/samber/lo"
	"github.com/theopenlane/core/common/enums"
)

// Code generated by ent. DO NOT EDIT.
// This file provides notification target resolvers for workflow-eligible schemas.

// NotificationTargetType represents the type of notification target
type NotificationTargetType string

const (
	NotificationTargetOwner            NotificationTargetType = "OWNER"
	NotificationTargetApprover         NotificationTargetType = "APPROVER"
	NotificationTargetDelegate         NotificationTargetType = "DELEGATE"
	NotificationTargetEditors          NotificationTargetType = "EDITORS"
	NotificationTargetControlOwner     NotificationTargetType = "CONTROL_OWNER"
	NotificationTargetResponsibleParty NotificationTargetType = "RESPONSIBLE_PARTY"
	NotificationTargetInitiator        NotificationTargetType = "INITIATOR"
)

// ResolveNotificationTargets returns user IDs for a given target type and workflow object
func (c *Client) ResolveNotificationTargets(ctx context.Context, objectType enums.WorkflowObjectType, objectID string, targetType NotificationTargetType) ([]string, error) {
	switch objectType {
	case enums.WorkflowObjectTypeActionPlan:
		return c.resolveActionPlanNotificationTargets(ctx, objectID, targetType)
	case enums.WorkflowObjectTypeCampaign:
		return c.resolveCampaignNotificationTargets(ctx, objectID, targetType)
	case enums.WorkflowObjectTypeCampaignTarget:
		return c.resolveCampaignTargetNotificationTargets(ctx, objectID, targetType)
	case enums.WorkflowObjectTypeControl:
		return c.resolveControlNotificationTargets(ctx, objectID, targetType)
	case enums.WorkflowObjectTypeEvidence:
		return c.resolveEvidenceNotificationTargets(ctx, objectID, targetType)
	case enums.WorkflowObjectTypeIdentityHolder:
		return c.resolveIdentityHolderNotificationTargets(ctx, objectID, targetType)
	case enums.WorkflowObjectTypeInternalPolicy:
		return c.resolveInternalPolicyNotificationTargets(ctx, objectID, targetType)
	case enums.WorkflowObjectTypePlatform:
		return c.resolvePlatformNotificationTargets(ctx, objectID, targetType)
	case enums.WorkflowObjectTypeProcedure:
		return c.resolveProcedureNotificationTargets(ctx, objectID, targetType)
	case enums.WorkflowObjectTypeSubcontrol:
		return c.resolveSubcontrolNotificationTargets(ctx, objectID, targetType)
	default:
		return nil, nil
	}
}

// resolveGroupMemberIDs resolves a group ID to its member user IDs
func (c *Client) resolveGroupMemberIDs(ctx context.Context, groupID string) ([]string, error) {
	if groupID == "" {
		return nil, nil
	}

	group, err := c.Group.Get(ctx, groupID)
	if err != nil {
		return nil, err
	}

	members, err := group.QueryMembers().All(ctx)
	if err != nil {
		return nil, err
	}

	userIDs := make([]string, 0, len(members))
	for _, member := range members {
		if member.UserID != "" {
			userIDs = append(userIDs, member.UserID)
		}
	}

	return userIDs, nil
}

// resolveGroupsMemberIDs resolves multiple group IDs to their member user IDs
func (c *Client) resolveGroupsMemberIDs(ctx context.Context, groupIDs []string) ([]string, error) {
	if len(groupIDs) == 0 {
		return nil, nil
	}

	var allUserIDs []string
	for _, groupID := range groupIDs {
		userIDs, err := c.resolveGroupMemberIDs(ctx, groupID)
		if err != nil {
			continue
		}
		allUserIDs = append(allUserIDs, userIDs...)
	}

	return lo.Uniq(allUserIDs), nil
}

// resolveActionPlanNotificationTargets resolves notification targets for ActionPlan
func (c *Client) resolveActionPlanNotificationTargets(ctx context.Context, objectID string, targetType NotificationTargetType) ([]string, error) {
	obj, err := c.ActionPlan.Get(ctx, objectID)
	if err != nil {
		return nil, err
	}

	switch targetType {
	case NotificationTargetOwner:
		if obj.OwnerID != "" {
			return []string{obj.OwnerID}, nil
		}
		return nil, nil
	case NotificationTargetInitiator:
		// Initiator is resolved from workflow instance context, not from the object
		return nil, nil
	case NotificationTargetType("APPROVER"):
		if obj.ApproverID != "" {
			return c.resolveGroupMemberIDs(ctx, obj.ApproverID)
		}
		return nil, nil
	case NotificationTargetType("DELEGATE"):
		if obj.DelegateID != "" {
			return c.resolveGroupMemberIDs(ctx, obj.DelegateID)
		}
		return nil, nil
	case NotificationTargetType("BLOCKED_GROUPS"):
		groups, err := obj.QueryBlockedGroups().IDs(ctx)
		if err != nil {
			return nil, err
		}
		return c.resolveGroupsMemberIDs(ctx, groups)
	case NotificationTargetType("EDITORS"):
		groups, err := obj.QueryEditors().IDs(ctx)
		if err != nil {
			return nil, err
		}
		return c.resolveGroupsMemberIDs(ctx, groups)
	case NotificationTargetType("VIEWERS"):
		groups, err := obj.QueryViewers().IDs(ctx)
		if err != nil {
			return nil, err
		}
		return c.resolveGroupsMemberIDs(ctx, groups)
	default:
		return nil, nil
	}
}

// resolveCampaignNotificationTargets resolves notification targets for Campaign
func (c *Client) resolveCampaignNotificationTargets(ctx context.Context, objectID string, targetType NotificationTargetType) ([]string, error) {
	obj, err := c.Campaign.Get(ctx, objectID)
	if err != nil {
		return nil, err
	}

	switch targetType {
	case NotificationTargetOwner:
		if obj.OwnerID != "" {
			return []string{obj.OwnerID}, nil
		}
		return nil, nil
	case NotificationTargetInitiator:
		// Initiator is resolved from workflow instance context, not from the object
		return nil, nil
	case NotificationTargetType("INTERNAL_OWNER_USER"):
		if obj.InternalOwnerUserID != "" {
			return []string{obj.InternalOwnerUserID}, nil
		}
		return nil, nil
	case NotificationTargetType("INTERNAL_OWNER_GROUP"):
		if obj.InternalOwnerGroupID != "" {
			return c.resolveGroupMemberIDs(ctx, obj.InternalOwnerGroupID)
		}
		return nil, nil
	case NotificationTargetType("GROUPS"):
		groups, err := obj.QueryGroups().IDs(ctx)
		if err != nil {
			return nil, err
		}
		return c.resolveGroupsMemberIDs(ctx, groups)
	default:
		return nil, nil
	}
}

// resolveCampaignTargetNotificationTargets resolves notification targets for CampaignTarget
func (c *Client) resolveCampaignTargetNotificationTargets(ctx context.Context, objectID string, targetType NotificationTargetType) ([]string, error) {
	obj, err := c.CampaignTarget.Get(ctx, objectID)
	if err != nil {
		return nil, err
	}

	switch targetType {
	case NotificationTargetOwner:
		if obj.OwnerID != "" {
			return []string{obj.OwnerID}, nil
		}
		return nil, nil
	case NotificationTargetInitiator:
		// Initiator is resolved from workflow instance context, not from the object
		return nil, nil
	case NotificationTargetType("USER"):
		if obj.UserID != "" {
			return []string{obj.UserID}, nil
		}
		return nil, nil
	case NotificationTargetType("GROUP"):
		if obj.GroupID != "" {
			return c.resolveGroupMemberIDs(ctx, obj.GroupID)
		}
		return nil, nil
	default:
		return nil, nil
	}
}

// resolveControlNotificationTargets resolves notification targets for Control
func (c *Client) resolveControlNotificationTargets(ctx context.Context, objectID string, targetType NotificationTargetType) ([]string, error) {
	obj, err := c.Control.Get(ctx, objectID)
	if err != nil {
		return nil, err
	}

	switch targetType {
	case NotificationTargetOwner:
		if obj.OwnerID != "" {
			return []string{obj.OwnerID}, nil
		}
		return nil, nil
	case NotificationTargetInitiator:
		// Initiator is resolved from workflow instance context, not from the object
		return nil, nil
	case NotificationTargetType("CONTROL_OWNER"):
		if obj.ControlOwnerID != nil && *obj.ControlOwnerID != "" {
			return c.resolveGroupMemberIDs(ctx, *obj.ControlOwnerID)
		}
		return nil, nil
	case NotificationTargetType("DELEGATE"):
		if obj.DelegateID != "" {
			return c.resolveGroupMemberIDs(ctx, obj.DelegateID)
		}
		return nil, nil
	case NotificationTargetType("BLOCKED_GROUPS"):
		groups, err := obj.QueryBlockedGroups().IDs(ctx)
		if err != nil {
			return nil, err
		}
		return c.resolveGroupsMemberIDs(ctx, groups)
	case NotificationTargetType("EDITORS"):
		groups, err := obj.QueryEditors().IDs(ctx)
		if err != nil {
			return nil, err
		}
		return c.resolveGroupsMemberIDs(ctx, groups)
	default:
		return nil, nil
	}
}

// resolveEvidenceNotificationTargets resolves notification targets for Evidence
func (c *Client) resolveEvidenceNotificationTargets(ctx context.Context, objectID string, targetType NotificationTargetType) ([]string, error) {
	obj, err := c.Evidence.Get(ctx, objectID)
	if err != nil {
		return nil, err
	}

	switch targetType {
	case NotificationTargetOwner:
		if obj.OwnerID != "" {
			return []string{obj.OwnerID}, nil
		}
		return nil, nil
	case NotificationTargetInitiator:
		// Initiator is resolved from workflow instance context, not from the object
		return nil, nil
	default:
		return nil, nil
	}
}

// resolveIdentityHolderNotificationTargets resolves notification targets for IdentityHolder
func (c *Client) resolveIdentityHolderNotificationTargets(ctx context.Context, objectID string, targetType NotificationTargetType) ([]string, error) {
	obj, err := c.IdentityHolder.Get(ctx, objectID)
	if err != nil {
		return nil, err
	}

	switch targetType {
	case NotificationTargetOwner:
		if obj.OwnerID != "" {
			return []string{obj.OwnerID}, nil
		}
		return nil, nil
	case NotificationTargetInitiator:
		// Initiator is resolved from workflow instance context, not from the object
		return nil, nil
	case NotificationTargetType("INTERNAL_OWNER_USER"):
		if obj.InternalOwnerUserID != "" {
			return []string{obj.InternalOwnerUserID}, nil
		}
		return nil, nil
	case NotificationTargetType("INTERNAL_OWNER_GROUP"):
		if obj.InternalOwnerGroupID != "" {
			return c.resolveGroupMemberIDs(ctx, obj.InternalOwnerGroupID)
		}
		return nil, nil
	case NotificationTargetType("USER"):
		if obj.UserID != "" {
			return []string{obj.UserID}, nil
		}
		return nil, nil
	default:
		return nil, nil
	}
}

// resolveInternalPolicyNotificationTargets resolves notification targets for InternalPolicy
func (c *Client) resolveInternalPolicyNotificationTargets(ctx context.Context, objectID string, targetType NotificationTargetType) ([]string, error) {
	obj, err := c.InternalPolicy.Get(ctx, objectID)
	if err != nil {
		return nil, err
	}

	switch targetType {
	case NotificationTargetOwner:
		if obj.OwnerID != "" {
			return []string{obj.OwnerID}, nil
		}
		return nil, nil
	case NotificationTargetInitiator:
		// Initiator is resolved from workflow instance context, not from the object
		return nil, nil
	case NotificationTargetType("BLOCKED_GROUPS"):
		groups, err := obj.QueryBlockedGroups().IDs(ctx)
		if err != nil {
			return nil, err
		}
		return c.resolveGroupsMemberIDs(ctx, groups)
	case NotificationTargetType("EDITORS"):
		groups, err := obj.QueryEditors().IDs(ctx)
		if err != nil {
			return nil, err
		}
		return c.resolveGroupsMemberIDs(ctx, groups)
	case NotificationTargetType("APPROVER"):
		if obj.ApproverID != "" {
			return c.resolveGroupMemberIDs(ctx, obj.ApproverID)
		}
		return nil, nil
	case NotificationTargetType("DELEGATE"):
		if obj.DelegateID != "" {
			return c.resolveGroupMemberIDs(ctx, obj.DelegateID)
		}
		return nil, nil
	default:
		return nil, nil
	}
}

// resolvePlatformNotificationTargets resolves notification targets for Platform
func (c *Client) resolvePlatformNotificationTargets(ctx context.Context, objectID string, targetType NotificationTargetType) ([]string, error) {
	obj, err := c.Platform.Get(ctx, objectID)
	if err != nil {
		return nil, err
	}

	switch targetType {
	case NotificationTargetOwner:
		if obj.OwnerID != "" {
			return []string{obj.OwnerID}, nil
		}
		return nil, nil
	case NotificationTargetInitiator:
		// Initiator is resolved from workflow instance context, not from the object
		return nil, nil
	case NotificationTargetType("INTERNAL_OWNER_USER"):
		if obj.InternalOwnerUserID != "" {
			return []string{obj.InternalOwnerUserID}, nil
		}
		return nil, nil
	case NotificationTargetType("INTERNAL_OWNER_GROUP"):
		if obj.InternalOwnerGroupID != "" {
			return c.resolveGroupMemberIDs(ctx, obj.InternalOwnerGroupID)
		}
		return nil, nil
	case NotificationTargetType("BUSINESS_OWNER_USER"):
		if obj.BusinessOwnerUserID != "" {
			return []string{obj.BusinessOwnerUserID}, nil
		}
		return nil, nil
	case NotificationTargetType("BUSINESS_OWNER_GROUP"):
		if obj.BusinessOwnerGroupID != "" {
			return c.resolveGroupMemberIDs(ctx, obj.BusinessOwnerGroupID)
		}
		return nil, nil
	case NotificationTargetType("TECHNICAL_OWNER_USER"):
		if obj.TechnicalOwnerUserID != "" {
			return []string{obj.TechnicalOwnerUserID}, nil
		}
		return nil, nil
	case NotificationTargetType("TECHNICAL_OWNER_GROUP"):
		if obj.TechnicalOwnerGroupID != "" {
			return c.resolveGroupMemberIDs(ctx, obj.TechnicalOwnerGroupID)
		}
		return nil, nil
	case NotificationTargetType("SECURITY_OWNER_USER"):
		if obj.SecurityOwnerUserID != "" {
			return []string{obj.SecurityOwnerUserID}, nil
		}
		return nil, nil
	case NotificationTargetType("SECURITY_OWNER_GROUP"):
		if obj.SecurityOwnerGroupID != "" {
			return c.resolveGroupMemberIDs(ctx, obj.SecurityOwnerGroupID)
		}
		return nil, nil
	case NotificationTargetType("PLATFORM_OWNER"):
		if obj.PlatformOwnerID != "" {
			return []string{obj.PlatformOwnerID}, nil
		}
		return nil, nil
	default:
		return nil, nil
	}
}

// resolveProcedureNotificationTargets resolves notification targets for Procedure
func (c *Client) resolveProcedureNotificationTargets(ctx context.Context, objectID string, targetType NotificationTargetType) ([]string, error) {
	obj, err := c.Procedure.Get(ctx, objectID)
	if err != nil {
		return nil, err
	}

	switch targetType {
	case NotificationTargetOwner:
		if obj.OwnerID != "" {
			return []string{obj.OwnerID}, nil
		}
		return nil, nil
	case NotificationTargetInitiator:
		// Initiator is resolved from workflow instance context, not from the object
		return nil, nil
	case NotificationTargetType("BLOCKED_GROUPS"):
		groups, err := obj.QueryBlockedGroups().IDs(ctx)
		if err != nil {
			return nil, err
		}
		return c.resolveGroupsMemberIDs(ctx, groups)
	case NotificationTargetType("EDITORS"):
		groups, err := obj.QueryEditors().IDs(ctx)
		if err != nil {
			return nil, err
		}
		return c.resolveGroupsMemberIDs(ctx, groups)
	case NotificationTargetType("APPROVER"):
		if obj.ApproverID != "" {
			return c.resolveGroupMemberIDs(ctx, obj.ApproverID)
		}
		return nil, nil
	case NotificationTargetType("DELEGATE"):
		if obj.DelegateID != "" {
			return c.resolveGroupMemberIDs(ctx, obj.DelegateID)
		}
		return nil, nil
	default:
		return nil, nil
	}
}

// resolveSubcontrolNotificationTargets resolves notification targets for Subcontrol
func (c *Client) resolveSubcontrolNotificationTargets(ctx context.Context, objectID string, targetType NotificationTargetType) ([]string, error) {
	obj, err := c.Subcontrol.Get(ctx, objectID)
	if err != nil {
		return nil, err
	}

	switch targetType {
	case NotificationTargetOwner:
		if obj.OwnerID != "" {
			return []string{obj.OwnerID}, nil
		}
		return nil, nil
	case NotificationTargetInitiator:
		// Initiator is resolved from workflow instance context, not from the object
		return nil, nil
	case NotificationTargetType("CONTROL_OWNER"):
		if obj.ControlOwnerID != nil && *obj.ControlOwnerID != "" {
			return c.resolveGroupMemberIDs(ctx, *obj.ControlOwnerID)
		}
		return nil, nil
	case NotificationTargetType("DELEGATE"):
		if obj.DelegateID != "" {
			return c.resolveGroupMemberIDs(ctx, obj.DelegateID)
		}
		return nil, nil
	default:
		return nil, nil
	}
}
