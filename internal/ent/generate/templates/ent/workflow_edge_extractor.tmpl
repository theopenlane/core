{{/* Generate edge mutation detection for workflow triggers */}}
{{/* gotype: entgo.io/ent/entc/gen.Graph */}}

{{ define "workflow_edge_extractor" }}

{{ $pkg := base $.Config.Package }}
package hooks

import (
	"entgo.io/ent"
	"github.com/theopenlane/core/internal/ent/generated"
)

// Code generated by ent. DO NOT EDIT.
// This file is generated to detect edge mutations for workflow triggers.

// extractChangedEdges inspects the mutation to determine which edge relationships were modified.
// It returns: edge names, added IDs per edge, removed IDs per edge.
func extractChangedEdges(m ent.Mutation) ([]string, map[string][]string, map[string][]string) {
	var edgeNames []string
	addedIDs := make(map[string][]string)
	removedIDs := make(map[string][]string)

	switch m.(type) {
{{- range $n := $.Nodes }}
	{{- $isHistory := hasSuffix $n.Name "History" }}
	{{- if not $isHistory }}
		{{- $hasAnyWorkflowEdge := false }}
		{{- range $e := $n.Edges }}
			{{- if $e.Annotations.OPENLANE_WORKFLOW_ELIGIBLE }}
				{{- $hasAnyWorkflowEdge = true }}
			{{- end }}
		{{- end }}
		{{- if $hasAnyWorkflowEdge }}
	case *generated.{{ $n.Name }}Mutation:
		mut := m.(*generated.{{ $n.Name }}Mutation)
			{{- range $e := $n.Edges }}
				{{- if $e.Annotations.OPENLANE_WORKFLOW_ELIGIBLE }}
				{{- if $e.Unique }}
		if ids := mut.{{ $e.StructField }}IDs(); len(ids) > 0 || mut.{{ $e.StructField }}Cleared() {
			edgeNames = append(edgeNames, "{{ $e.Name }}")
			if len(ids) > 0 {
				addedIDs["{{ $e.Name }}"] = ids
			}
			if mut.{{ $e.StructField }}Cleared() {
				removedIDs["{{ $e.Name }}"] = []string{}
			}
		}
				{{- else }}
		if ids := mut.{{ $e.StructField }}IDs(); len(ids) > 0 || len(mut.Removed{{ $e.StructField }}IDs()) > 0 || mut.{{ $e.StructField }}Cleared() {
			edgeNames = append(edgeNames, "{{ $e.Name }}")
			if len(ids) > 0 {
				addedIDs["{{ $e.Name }}"] = ids
			}
			if removed := mut.Removed{{ $e.StructField }}IDs(); len(removed) > 0 {
				removedIDs["{{ $e.Name }}"] = removed
			}
		}
				{{- end }}
				{{- end }}
			{{- end }}
		{{- end }}
	{{- end }}
{{- end }}
	}

	return edgeNames, addedIDs, removedIDs
}

{{ end }}
