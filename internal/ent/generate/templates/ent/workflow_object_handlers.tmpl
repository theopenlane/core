{{/* Generate object handler functions for workflow engine operations */}}
{{/* gotype: entgo.io/ent/entc/gen.Graph */}}

{{ define "workflow_object_handlers" }}

{{ $pkg := base $.Config.Package }}
package generated

import (
	"context"

	"entgo.io/ent/dialect/sql"
	"github.com/theopenlane/core/internal/ent/generated/workflowinstance"
	"github.com/theopenlane/core/internal/ent/generated/workflowobjectref"
	"github.com/theopenlane/core/common/enums"
)

// Code generated by ent. DO NOT EDIT.
// This file is generated to provide object handler functions for workflow engine operations.

{{- $workflowTypes := dict }}
{{- range $n := $.Nodes }}
	{{- $hasWorkflowFields := false }}
	{{- $isHistory := false }}
	{{- if hasSuffix $n.Name "History" }}{{ $isHistory = true }}{{ end }}
	{{- range $f := $n.Fields }}
		{{- if $f.Annotations.OPENLANE_WORKFLOW_ELIGIBLE }}{{ $hasWorkflowFields = true }}{{ end }}
	{{- end }}
	{{- if and $hasWorkflowFields (not $isHistory) }}
		{{- $_ := set $workflowTypes $n.Name true }}
	{{- end }}
{{- end }}

// SetWorkflowInstanceObjectID sets the appropriate object ID field on a WorkflowInstance create builder based on object type
func SetWorkflowInstanceObjectID(builder *WorkflowInstanceCreate, objectType enums.WorkflowObjectType, objectID string) *WorkflowInstanceCreate {
	switch objectType {
{{- range $n := $.Nodes }}
	{{- if hasKey $workflowTypes $n.Name }}
	case enums.WorkflowObjectType{{ $n.Name }}:
		return builder.Set{{ $n.Name }}ID(objectID)
	{{- end }}
{{- end }}
	default:
		return builder
	}
}

// SetWorkflowObjectRefObjectID sets the appropriate object ID field on a WorkflowObjectRef create builder based on object type
func SetWorkflowObjectRefObjectID(builder *WorkflowObjectRefCreate, objectType enums.WorkflowObjectType, objectID string) *WorkflowObjectRefCreate {
	switch objectType {
{{- range $n := $.Nodes }}
	{{- if hasKey $workflowTypes $n.Name }}
	case enums.WorkflowObjectType{{ $n.Name }}:
		return builder.Set{{ $n.Name }}ID(objectID)
	{{- end }}
{{- end }}
	default:
		return builder
	}
}

// ApplyWorkflowInstanceObjectPredicate adds the appropriate object ID predicate to a WorkflowInstance query based on object type
func ApplyWorkflowInstanceObjectPredicate(query *WorkflowInstanceQuery, objectType enums.WorkflowObjectType, objectID string) *WorkflowInstanceQuery {
	switch objectType {
{{- range $n := $.Nodes }}
	{{- if hasKey $workflowTypes $n.Name }}
	case enums.WorkflowObjectType{{ $n.Name }}:
		return query.Where(workflowinstance.{{ $n.Name }}IDEQ(objectID))
	{{- end }}
{{- end }}
	default:
		return query
	}
}

// ApplyWorkflowObjectRefObjectPredicate adds the appropriate object ID predicate to a WorkflowObjectRef query based on object type.
func ApplyWorkflowObjectRefObjectPredicate(query *WorkflowObjectRefQuery, objectType enums.WorkflowObjectType, objectID string) *WorkflowObjectRefQuery {
	switch objectType {
{{- range $n := $.Nodes }}
	{{- if hasKey $workflowTypes $n.Name }}
	case enums.WorkflowObjectType{{ $n.Name }}:
		return query.Where(workflowobjectref.{{ $n.Name }}IDEQ(objectID))
	{{- end }}
{{- end }}
	default:
		return query
	}
}

// GetObjectOwnerID retrieves the owner ID for a workflow object by loading it from the database
func GetObjectOwnerID(ctx context.Context, client *Client, objectType enums.WorkflowObjectType, objectID string) (string, error) {
	switch objectType {
{{- range $n := $.Nodes }}
	{{- if hasKey $workflowTypes $n.Name }}
	case enums.WorkflowObjectType{{ $n.Name }}:
		rec, err := client.{{ $n.Name }}.Get(ctx, objectID)
		if err != nil {
			return "", err
		}
		return rec.OwnerID, nil
	{{- end }}
{{- end }}
	default:
		return "", nil
	}
}

// ApplyObjectFieldUpdates applies field updates to a workflow object using the generated ApplyFieldUpdates method
func ApplyObjectFieldUpdates(ctx context.Context, client *Client, objectType enums.WorkflowObjectType, objectID string, updates map[string]any) error {
	switch objectType {
{{- range $n := $.Nodes }}
	{{- if hasKey $workflowTypes $n.Name }}
	case enums.WorkflowObjectType{{ $n.Name }}:
		return client.{{ $n.Name }}.ApplyFieldUpdates(ctx, objectID, updates)
	{{- end }}
{{- end }}
	default:
		return nil
	}
}


{{ end }}
