{{/* Generate workflow object loading helpers */}}
{{/* gotype: entgo.io/ent/entc/gen.Graph */}}

{{ define "workflow_object_loader" }}

{{/* Add the base header for the generated file */}}
{{ $pkg := base $.Config.Package }}
{{ template "header" $ }}

import (
	"github.com/theopenlane/core/common/enums"
)

// LoadWorkflowObject loads a workflow object entity by schema type and ID with optional eager loading
// Returns the entity as an interface{} to avoid import cycles - caller should type assert
func (c *Client) LoadWorkflowObject(ctx context.Context, schemaType string, entityID string) (any, error) {
	switch schemaType {
	{{- range $n := $.Nodes }}
	{{- $hasWorkflowFields := false }}
	{{- $isHistory := false }}
	{{- $eagerLoadEdges := list }}
	{{- range $f := $n.Fields }}
		{{- if $f.Annotations.OPENLANE_WORKFLOW_ELIGIBLE }}
			{{- $hasWorkflowFields = true }}
		{{- end }}
	{{- end }}
	{{- if $n.Annotations.History }}
		{{- if $n.Annotations.History.isHistory }}
			{{- $isHistory = true }}
		{{- end }}
	{{- end }}
	{{- if $n.Annotations.OPENLANE_WORKFLOW_OBJECT_CONFIG }}
		{{- $eagerLoadEdges = $n.Annotations.OPENLANE_WORKFLOW_OBJECT_CONFIG.EagerLoadEdges }}
	{{- end }}
	{{- if and $hasWorkflowFields (not $isHistory) }}
	case Type{{ $n.Name }}:
		query := c.{{ $n.Name }}.Query().Where({{ $n.Package }}.ID(entityID))
		{{- if $eagerLoadEdges }}
		{{- range $edge := $eagerLoadEdges }}
		query = query.With{{ pascal $edge }}()
		{{- end }}
		{{- end }}
		entity, err := query.Only(ctx)
		if err != nil {
			return nil, err
		}
		return entity, nil
	{{- end }}
	{{- end }}
	default:
		return nil, fmt.Errorf("unsupported schema type: %s", schemaType)
	}
}

{{- range $n := $.Nodes }}
{{- $hasWorkflowFields := false }}
{{- $isHistory := false }}
{{- $eagerLoadEdges := list }}
{{- range $f := $n.Fields }}
	{{- if $f.Annotations.OPENLANE_WORKFLOW_ELIGIBLE }}
		{{- $hasWorkflowFields = true }}
	{{- end }}
{{- end }}
{{- if $n.Annotations.History }}
	{{- if $n.Annotations.History.isHistory }}
		{{- $isHistory = true }}
	{{- end }}
{{- end }}
{{- if $n.Annotations.OPENLANE_WORKFLOW_OBJECT_CONFIG }}
	{{- $eagerLoadEdges = $n.Annotations.OPENLANE_WORKFLOW_OBJECT_CONFIG.EagerLoadEdges }}
{{- end }}
{{- if and $hasWorkflowFields (not $isHistory) }}

// Load{{ $n.Name }}WorkflowObject loads a {{ $n.Name }} entity with eager loading for workflow processing
func (c *Client) Load{{ $n.Name }}WorkflowObject(ctx context.Context, id string) (*{{ $n.Name }}, error) {
	query := c.{{ $n.Name }}.Query().Where({{ $n.Package }}.ID(id))
	{{- if $eagerLoadEdges }}
	{{- range $edge := $eagerLoadEdges }}
	query = query.With{{ pascal $edge }}()
	{{- end }}
	{{- end }}
	return query.Only(ctx)
}
{{- end }}
{{- end }}

{{ end }}
