{{/* Generate workflow event recording helpers */}}
{{/* gotype: entgo.io/ent/entc/gen.Graph */}}

{{ define "workflow_event_helpers" }}

{{/* Add the base header for the generated file */}}
{{ $pkg := base $.Config.Package }}
{{ template "header" $ }}

import (
	"encoding/json"

	"github.com/theopenlane/core/common/enums"
	"github.com/theopenlane/core/common/models"
)

// WorkflowEventRecorder provides type-safe methods for recording workflow execution events
type WorkflowEventRecorder struct {
	client *Client
}

// NewWorkflowEventRecorder creates a new WorkflowEventRecorder
func NewWorkflowEventRecorder(client *Client) *WorkflowEventRecorder {
	return &WorkflowEventRecorder{client: client}
}

// RecordInstanceTriggered records that a workflow instance was triggered
func (r *WorkflowEventRecorder) RecordInstanceTriggered(ctx context.Context, instanceID string, definitionID string, objectType enums.WorkflowObjectType, objectID string) error {
	details, _ := json.Marshal(map[string]any{
		"definition_id": definitionID,
		"object_type":   objectType,
		"object_id":     objectID,
	})
	payload := models.WorkflowEventPayload{
		EventType: enums.WorkflowEventTypeInstanceTriggered,
		Details:   details,
	}
	return r.client.WorkflowEvent.Create().
		SetWorkflowInstanceID(instanceID).
		SetEventType(enums.WorkflowEventTypeInstanceTriggered).
		SetPayload(payload).
		Exec(ctx)
}

// RecordActionStarted records that a workflow action started execution
func (r *WorkflowEventRecorder) RecordActionStarted(ctx context.Context, instanceID string, actionIndex int, actionType enums.WorkflowActionType, actionKey string) error {
	details, _ := json.Marshal(map[string]any{
		"action_index": actionIndex,
		"action_type":  actionType,
	})
	payload := models.WorkflowEventPayload{
		EventType: enums.WorkflowEventTypeActionStarted,
		ActionKey: actionKey,
		Details:   details,
	}
	return r.client.WorkflowEvent.Create().
		SetWorkflowInstanceID(instanceID).
		SetEventType(enums.WorkflowEventTypeActionStarted).
		SetPayload(payload).
		Exec(ctx)
}

// RecordActionCompleted records that a workflow action completed successfully
func (r *WorkflowEventRecorder) RecordActionCompleted(ctx context.Context, instanceID string, actionIndex int, actionKey string, success bool, errorMsg string) error {
	detailsMap := map[string]any{
		"action_index": actionIndex,
		"success":      success,
	}
	if errorMsg != "" {
		detailsMap["error"] = errorMsg
	}
	details, _ := json.Marshal(detailsMap)
	payload := models.WorkflowEventPayload{
		EventType: enums.WorkflowEventTypeActionCompleted,
		ActionKey: actionKey,
		Details:   details,
	}
	return r.client.WorkflowEvent.Create().
		SetWorkflowInstanceID(instanceID).
		SetEventType(enums.WorkflowEventTypeActionCompleted).
		SetPayload(payload).
		Exec(ctx)
}

// RecordActionFailed records that a workflow action failed
func (r *WorkflowEventRecorder) RecordActionFailed(ctx context.Context, instanceID string, actionIndex int, actionKey string, errorMsg string) error {
	details, _ := json.Marshal(map[string]any{
		"action_index": actionIndex,
		"error":        errorMsg,
	})
	payload := models.WorkflowEventPayload{
		EventType: enums.WorkflowEventTypeActionFailed,
		ActionKey: actionKey,
		Details:   details,
	}
	return r.client.WorkflowEvent.Create().
		SetWorkflowInstanceID(instanceID).
		SetEventType(enums.WorkflowEventTypeActionFailed).
		SetPayload(payload).
		Exec(ctx)
}

// RecordConditionEvaluated records the result of a condition evaluation
func (r *WorkflowEventRecorder) RecordConditionEvaluated(ctx context.Context, instanceID string, condition string, result bool) error {
	details, _ := json.Marshal(map[string]any{
		"condition": condition,
		"result":    result,
	})
	payload := models.WorkflowEventPayload{
		EventType: enums.WorkflowEventTypeConditionEvaluated,
		Details:   details,
	}
	return r.client.WorkflowEvent.Create().
		SetWorkflowInstanceID(instanceID).
		SetEventType(enums.WorkflowEventTypeConditionEvaluated).
		SetPayload(payload).
		Exec(ctx)
}

// RecordAssignmentCreated records that a workflow assignment was created
func (r *WorkflowEventRecorder) RecordAssignmentCreated(ctx context.Context, instanceID string, assignmentID string, userID string) error {
	details, _ := json.Marshal(map[string]any{
		"assignment_id": assignmentID,
		"user_id":       userID,
	})
	payload := models.WorkflowEventPayload{
		EventType: enums.WorkflowEventTypeAssignmentCreated,
		Details:   details,
	}
	return r.client.WorkflowEvent.Create().
		SetWorkflowInstanceID(instanceID).
		SetEventType(enums.WorkflowEventTypeAssignmentCreated).
		SetPayload(payload).
		Exec(ctx)
}

// RecordAssignmentResolved records that a workflow assignment was resolved
func (r *WorkflowEventRecorder) RecordAssignmentResolved(ctx context.Context, instanceID string, assignmentID string, userID string, status enums.WorkflowAssignmentStatus) error {
	details, _ := json.Marshal(map[string]any{
		"assignment_id": assignmentID,
		"user_id":       userID,
		"status":        status,
	})
	payload := models.WorkflowEventPayload{
		EventType: enums.WorkflowEventTypeAssignmentResolved,
		Details:   details,
	}
	return r.client.WorkflowEvent.Create().
		SetWorkflowInstanceID(instanceID).
		SetEventType(enums.WorkflowEventTypeAssignmentResolved).
		SetPayload(payload).
		Exec(ctx)
}

// RecordInstancePaused records that a workflow instance was paused
func (r *WorkflowEventRecorder) RecordInstancePaused(ctx context.Context, instanceID string, reason string) error {
	details, _ := json.Marshal(map[string]any{
		"reason": reason,
	})
	payload := models.WorkflowEventPayload{
		EventType: enums.WorkflowEventTypeInstancePaused,
		Details:   details,
	}
	return r.client.WorkflowEvent.Create().
		SetWorkflowInstanceID(instanceID).
		SetEventType(enums.WorkflowEventTypeInstancePaused).
		SetPayload(payload).
		Exec(ctx)
}

// RecordInstanceResumed records that a workflow instance was resumed
func (r *WorkflowEventRecorder) RecordInstanceResumed(ctx context.Context, instanceID string) error {
	details, _ := json.Marshal(map[string]any{})
	payload := models.WorkflowEventPayload{
		EventType: enums.WorkflowEventTypeInstanceResumed,
		Details:   details,
	}
	return r.client.WorkflowEvent.Create().
		SetWorkflowInstanceID(instanceID).
		SetEventType(enums.WorkflowEventTypeInstanceResumed).
		SetPayload(payload).
		Exec(ctx)
}

// RecordInstanceCompleted records that a workflow instance completed
func (r *WorkflowEventRecorder) RecordInstanceCompleted(ctx context.Context, instanceID string, finalState enums.WorkflowInstanceState) error {
	details, _ := json.Marshal(map[string]any{
		"final_state": finalState,
	})
	payload := models.WorkflowEventPayload{
		EventType: enums.WorkflowEventTypeInstanceCompleted,
		Details:   details,
	}
	return r.client.WorkflowEvent.Create().
		SetWorkflowInstanceID(instanceID).
		SetEventType(enums.WorkflowEventTypeInstanceCompleted).
		SetPayload(payload).
		Exec(ctx)
}

{{ end }}
