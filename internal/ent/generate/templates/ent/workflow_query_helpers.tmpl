{{/* Generate workflow query helper methods */}}
{{/* gotype: entgo.io/ent/entc/gen.Graph */}}

{{ define "workflow_query_helpers" }}

{{/* Add the base header for the generated file */}}
{{ $pkg := base $.Config.Package }}
{{ template "header" $ }}

import (
	"github.com/theopenlane/core/internal/ent/generated/workflowinstance"
	"github.com/theopenlane/core/internal/ent/generated/workflowobjectref"
	"github.com/theopenlane/core/common/enums"
)

{{- range $n := $.Nodes }}
{{- $hasWorkflowFields := false }}
{{- $isHistory := false }}
{{- range $f := $n.Fields }}
    {{- if $f.Annotations.OPENLANE_WORKFLOW_ELIGIBLE }}
        {{- $hasWorkflowFields = true }}
    {{- end }}
{{- end }}
{{- if $n.Annotations.History }}
    {{- if $n.Annotations.History.isHistory }}
        {{- $isHistory = true }}
    {{- end }}
{{- end }}

{{- if and $hasWorkflowFields (not $isHistory) }}

// Pending{{ $n.Name }}WorkflowInstances returns all running workflow instances for a specific {{ $n.Name }}
func (c *Client) Pending{{ $n.Name }}WorkflowInstances(ctx context.Context, objectID string) ([]*WorkflowInstance, error) {
	return c.WorkflowObjectRef.Query().
		Where(workflowobjectref.{{ pascal $n.Name }}IDEQ(objectID)).
		QueryWorkflowInstance().
		Where(workflowinstance.StateEQ(enums.WorkflowInstanceStateRunning)).
		All(ctx)
}

// {{ $n.Name }}EntitiesWithPendingWorkflows returns all {{ $n.Name }} entities that have pending workflow proposals
func (c *Client) {{ $n.Name }}EntitiesWithPendingWorkflows(ctx context.Context) ([]*{{ $n.Name }}, error) {
	return c.{{ $n.Name }}.Query().
		Where({{ $n.Package }}.HasWorkflowObjectRefsWith(
			workflowobjectref.HasWorkflowProposalsWith(),
		)).
		All(ctx)
}

// {{ $n.Name }}EntitiesWithActiveWorkflows returns all {{ $n.Name }} entities that have running workflow instances
func (c *Client) {{ $n.Name }}EntitiesWithActiveWorkflows(ctx context.Context) ([]*{{ $n.Name }}, error) {
	return c.{{ $n.Name }}.Query().
		Where({{ $n.Package }}.HasWorkflowObjectRefsWith(
			workflowobjectref.HasWorkflowInstanceWith(
				workflowinstance.StateEQ(enums.WorkflowInstanceStateRunning),
			),
		)).
		All(ctx)
}

{{- end }}
{{- end }}

{{ end }}
