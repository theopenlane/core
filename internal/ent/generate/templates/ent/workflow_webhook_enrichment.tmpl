{{/* Generate webhook payload enrichment helpers */}}
{{/* gotype: entgo.io/ent/entc/gen.Graph */}}

{{ define "workflow_webhook_enrichment" }}

{{/* Add the base header for the generated file */}}
{{ $pkg := base $.Config.Package }}
{{ template "header" $ }}

import (
	"github.com/theopenlane/core/common/enums"
)

// EnrichWebhookPayload enriches a webhook payload with fields from a workflow object
func (c *Client) EnrichWebhookPayload(ctx context.Context, objectType enums.WorkflowObjectType, objectID string, payload map[string]any) error {
	switch objectType {
	{{- range $n := $.Nodes }}
	{{- $hasWorkflowFields := false }}
	{{- $isHistory := false }}
	{{- $hasWebhookFields := false }}
	{{- range $f := $n.Fields }}
		{{- if $f.Annotations.OPENLANE_WORKFLOW_ELIGIBLE }}
			{{- $hasWorkflowFields = true }}
		{{- end }}
		{{- if $f.Annotations.OPENLANE_WEBHOOK_PAYLOAD_FIELD }}
			{{- $hasWebhookFields = true }}
		{{- end }}
	{{- end }}
	{{- if $n.Annotations.History }}
		{{- if $n.Annotations.History.isHistory }}
			{{- $isHistory = true }}
		{{- end }}
	{{- end }}
	{{- if and $hasWorkflowFields (not $isHistory) }}
	case enums.WorkflowObjectType{{ $n.Name }}:
		entity, err := c.{{ $n.Name }}.Get(ctx, objectID)
		if err != nil {
			return err
		}
		{{- if $hasWebhookFields }}
		{{- range $f := $n.Fields }}
		{{- if $f.Annotations.OPENLANE_WEBHOOK_PAYLOAD_FIELD }}
		payload["{{ $f.Name }}"] = entity.{{ pascal $f.Name }}
		{{- end }}
		{{- end }}
		{{- else }}
		// No fields marked with WebhookPayloadField annotation
		payload["id"] = entity.ID
		{{- end }}
		return nil
	{{- end }}
	{{- end }}
	default:
		return fmt.Errorf("unsupported object type: %s", objectType)
	}
}

{{- range $n := $.Nodes }}
{{- $hasWorkflowFields := false }}
{{- $isHistory := false }}
{{- $hasWebhookFields := false }}
{{- range $f := $n.Fields }}
	{{- if $f.Annotations.OPENLANE_WORKFLOW_ELIGIBLE }}
		{{- $hasWorkflowFields = true }}
	{{- end }}
	{{- if $f.Annotations.OPENLANE_WEBHOOK_PAYLOAD_FIELD }}
		{{- $hasWebhookFields = true }}
	{{- end }}
{{- end }}
{{- if $n.Annotations.History }}
	{{- if $n.Annotations.History.isHistory }}
		{{- $isHistory = true }}
	{{- end }}
{{- end }}
{{- if and $hasWorkflowFields (not $isHistory) }}

// Enrich{{ $n.Name }}WebhookPayload enriches a webhook payload with {{ $n.Name }} fields
func (c *Client) Enrich{{ $n.Name }}WebhookPayload(ctx context.Context, id string, payload map[string]any) error {
	entity, err := c.{{ $n.Name }}.Get(ctx, id)
	if err != nil {
		return err
	}
	{{- if $hasWebhookFields }}
	{{- range $f := $n.Fields }}
	{{- if $f.Annotations.OPENLANE_WEBHOOK_PAYLOAD_FIELD }}
	payload["{{ $f.Name }}"] = entity.{{ pascal $f.Name }}
	{{- end }}
	{{- end }}
	{{- else }}
	payload["id"] = entity.ID
	{{- end }}
	return nil
}
{{- end }}
{{- end }}

{{ end }}
