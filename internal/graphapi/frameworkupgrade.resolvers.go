package graphapi

// This file will be automatically regenerated based on the schema, any resolver
// implementations
// will be copied through when generating and any unknown code will be moved to the end.
// Code generated by github.com/99designs/gqlgen

import (
	"context"

	"github.com/theopenlane/core/internal/graphapi/common"
	"github.com/theopenlane/core/internal/graphapi/model"
)

// ApplyFrameworkUpgrade is the resolver for the applyFrameworkUpgrade field.
func (r *mutationResolver) ApplyFrameworkUpgrade(ctx context.Context, input model.ApplyFrameworkUpgradeInput) (*model.ApplyFrameworkUpgradePayload, error) {
	// First calculate the diff to get summary information
	diff, err := r.calculateFrameworkUpgradeDiff(ctx, input.StandardID, input.TargetRevision)
	if err != nil {
		return nil, parseRequestError(ctx, err, common.Action{Action: common.ActionUpdate, Object: "framework"})
	}

	// Apply the upgrade
	err = r.applyFrameworkUpgrade(ctx, input.StandardID, input.TargetRevision)
	if err != nil {
		return nil, parseRequestError(ctx, err, common.Action{Action: common.ActionUpdate, Object: "framework"})
	}

	addedCount := len(diff.AddedControls)
	updatedCount := len(diff.UpdatedControls)
	removedCount := len(diff.RemovedControls)
	unchangedCount := len(diff.UnchangedControls)

	message := "Framework upgrade completed successfully"

	return &model.ApplyFrameworkUpgradePayload{
		Success: true,
		Summary: &model.FrameworkUpgradeSummary{
			AddedCount:     addedCount,
			UpdatedCount:   updatedCount,
			RemovedCount:   removedCount,
			UnchangedCount: unchangedCount,
			TotalAffected:  addedCount + updatedCount + removedCount,
		},
		Message: &message,
	}, nil
}

// FrameworkUpgradeDiff is the resolver for the frameworkUpgradeDiff field.
func (r *queryResolver) FrameworkUpgradeDiff(ctx context.Context, input model.FrameworkUpgradeDiffInput) (*model.FrameworkUpgradeDiff, error) {
	diff, err := r.calculateFrameworkUpgradeDiff(ctx, input.StandardID, input.TargetRevision)
	if err != nil {
		return nil, parseRequestError(ctx, err, common.Action{Action: common.ActionGet, Object: "framework upgrade diff"})
	}

	// Convert internal diff to GraphQL model
	updatedControls := make([]*model.ControlUpdateChange, len(diff.UpdatedControls))
	for i, update := range diff.UpdatedControls {
		updatedControls[i] = &model.ControlUpdateChange{
			CurrentControl: update.CurrentControl,
			TargetControl:  update.TargetControl,
			Changes:        update.Changes,
		}
	}

	addedCount := len(diff.AddedControls)
	updatedCount := len(diff.UpdatedControls)
	removedCount := len(diff.RemovedControls)
	unchangedCount := len(diff.UnchangedControls)

	return &model.FrameworkUpgradeDiff{
		CurrentStandard:   diff.CurrentStandard,
		TargetStandard:    diff.TargetStandard,
		AddedControls:     diff.AddedControls,
		UpdatedControls:   updatedControls,
		RemovedControls:   diff.RemovedControls,
		UnchangedControls: diff.UnchangedControls,
		Summary: &model.FrameworkUpgradeSummary{
			AddedCount:     addedCount,
			UpdatedCount:   updatedCount,
			RemovedCount:   removedCount,
			UnchangedCount: unchangedCount,
			TotalAffected:  addedCount + updatedCount + removedCount,
		},
	}, nil
}
