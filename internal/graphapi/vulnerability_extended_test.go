package graphapi_test

import (
	"context"
	"testing"

	"gotest.tools/v3/assert"
	is "gotest.tools/v3/assert/cmp"

	"github.com/theopenlane/core/internal/graphapi"
	"github.com/theopenlane/core/internal/graphapi/model"
	"github.com/theopenlane/utils/ulids"
)

func TestResolveVulnerability(t *testing.T) {
	user := suite.userBuilder(context.Background(), t)
	ctx := setContext(user.UserCtx, suite.client.db)

	resolver := graphapi.NewResolver(suite.client.db, nil)

	vuln, err := suite.client.db.Vulnerability.Create().
		SetOwnerID(user.OrganizationID).
		SetExternalID("VUL-" + ulids.New().String()).
		SetDisplayName("Test Vulnerability").
		Save(ctx)
	assert.NilError(t, err)

	createReview := true
	reason := "fixed"
	details := "patched and verified"
	input := model.ResolveVulnerabilityInput{
		Status:       "resolved",
		Reason:       &reason,
		Details:      &details,
		CreateReview: &createReview,
	}

	res, err := resolver.Mutation().ResolveVulnerability(ctx, vuln.ID, input)
	assert.NilError(t, err)
	assert.Check(t, res != nil)
	assert.Check(t, res.Vulnerability != nil)
	assert.Check(t, is.Equal(res.Vulnerability.Status, "resolved"))
	assert.Check(t, is.Equal(res.Vulnerability.Open, false))
	assert.Check(t, res.Review != nil)
	assert.Check(t, is.Equal(res.Review.Category, "resolution"))
	assert.Check(t, is.Equal(res.Review.State, "resolved"))
	assert.Check(t, is.Equal(res.Review.Details, details))
}
