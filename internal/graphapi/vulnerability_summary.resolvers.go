package graphapi

// This file will be automatically regenerated based on the schema, any resolver
// implementations
// will be copied through when generating and any unknown code will be moved to the end.
// Code generated by github.com/99designs/gqlgen

import (
	"context"

	"github.com/samber/lo"
	"github.com/theopenlane/core/internal/ent/generated"
	"github.com/theopenlane/core/internal/ent/generated/vulnerability"
	"github.com/theopenlane/core/internal/graphapi/common"
	"github.com/theopenlane/core/internal/graphapi/model"
)

// VulnerabilitySummary is the resolver for the vulnerabilitySummary field.
func (r *queryResolver) VulnerabilitySummary(ctx context.Context, where *generated.VulnerabilityWhereInput) (*model.VulnerabilitySummary, error) {
	query := withTransactionalMutation(ctx).Vulnerability.Query()
	if where != nil {
		var err error
		query, err = where.Filter(query)
		if err != nil {
			return nil, parseRequestError(ctx, err, common.Action{Action: common.ActionGet, Object: "vulnerabilitysummary"})
		}
	}

	total, err := query.Clone().Count(ctx)
	if err != nil {
		return nil, parseRequestError(ctx, err, common.Action{Action: common.ActionGet, Object: "vulnerabilitysummary"})
	}

	type keyCount struct {
		Key   string `json:"key"`
		Count int    `json:"count"`
	}

	scanBuckets := func(q *generated.VulnerabilityQuery, field string) ([]*model.VulnerabilitySummaryBucket, error) {
		var rows []keyCount
		if err := q.GroupBy(field).Aggregate(generated.As(generated.Count(), "count")).Scan(ctx, &rows); err != nil {
			return nil, err
		}
		return lo.Map(rows, func(row keyCount, _ int) *model.VulnerabilitySummaryBucket {
			return &model.VulnerabilitySummaryBucket{Key: row.Key, Count: row.Count}
		}), nil
	}

	bySeverity, err := scanBuckets(query.Clone().Where(vulnerability.SeverityNEQ("")), vulnerability.FieldSeverity)
	if err != nil {
		return nil, parseRequestError(ctx, err, common.Action{Action: common.ActionGet, Object: "vulnerabilitysummary"})
	}

	bySource, err := scanBuckets(query.Clone().Where(vulnerability.SourceNEQ("")), vulnerability.FieldSource)
	if err != nil {
		return nil, parseRequestError(ctx, err, common.Action{Action: common.ActionGet, Object: "vulnerabilitysummary"})
	}

	byStatus, err := scanBuckets(query.Clone().Where(vulnerability.StatusNEQ("")), vulnerability.FieldStatus)
	if err != nil {
		return nil, parseRequestError(ctx, err, common.Action{Action: common.ActionGet, Object: "vulnerabilitysummary"})
	}

	return &model.VulnerabilitySummary{
		Total:      total,
		BySeverity: bySeverity,
		BySource:   bySource,
		ByStatus:   byStatus,
	}, nil
}
