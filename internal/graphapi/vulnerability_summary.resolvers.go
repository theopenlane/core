package graphapi

// This file will be automatically regenerated based on the schema, any resolver
// implementations
// will be copied through when generating and any unknown code will be moved to the end.
// Code generated by github.com/99designs/gqlgen

import (
	"context"

	"github.com/theopenlane/core/internal/ent/generated"
	"github.com/theopenlane/core/internal/ent/generated/vulnerability"
	"github.com/theopenlane/core/internal/graphapi/common"
	"github.com/theopenlane/core/internal/graphapi/model"
)

// VulnerabilitySummary is the resolver for the vulnerabilitySummary field.
func (r *queryResolver) VulnerabilitySummary(ctx context.Context, where *generated.VulnerabilityWhereInput) (*model.VulnerabilitySummary, error) {
	query := withTransactionalMutation(ctx).Vulnerability.Query()
	if where != nil {
		var err error
		query, err = where.Filter(query)
		if err != nil {
			return nil, parseRequestError(ctx, err, common.Action{Action: common.ActionGet, Object: "vulnerabilitysummary"})
		}
	}

	total, err := query.Clone().Count(ctx)
	if err != nil {
		return nil, parseRequestError(ctx, err, common.Action{Action: common.ActionGet, Object: "vulnerabilitysummary"})
	}

	var severityRows []struct {
		Severity string `json:"severity"`
		Count    int    `json:"count"`
	}
	if err := query.Clone().
		Where(vulnerability.SeverityNEQ("")).
		GroupBy(vulnerability.FieldSeverity).
		Aggregate(generated.Count()).
		Scan(ctx, &severityRows); err != nil {
		return nil, parseRequestError(ctx, err, common.Action{Action: common.ActionGet, Object: "vulnerabilitysummary"})
	}

	var sourceRows []struct {
		Source string `json:"source"`
		Count  int    `json:"count"`
	}
	if err := query.Clone().
		Where(vulnerability.SourceNEQ("")).
		GroupBy(vulnerability.FieldSource).
		Aggregate(generated.Count()).
		Scan(ctx, &sourceRows); err != nil {
		return nil, parseRequestError(ctx, err, common.Action{Action: common.ActionGet, Object: "vulnerabilitysummary"})
	}

	var statusRows []struct {
		Status string `json:"status"`
		Count  int    `json:"count"`
	}
	if err := query.Clone().
		Where(vulnerability.StatusNEQ("")).
		GroupBy(vulnerability.FieldStatus).
		Aggregate(generated.Count()).
		Scan(ctx, &statusRows); err != nil {
		return nil, parseRequestError(ctx, err, common.Action{Action: common.ActionGet, Object: "vulnerabilitysummary"})
	}

	bySeverity := make([]*model.VulnerabilitySummaryBucket, 0, len(severityRows))
	for _, row := range severityRows {
		bySeverity = append(bySeverity, &model.VulnerabilitySummaryBucket{
			Key:   row.Severity,
			Count: row.Count,
		})
	}

	bySource := make([]*model.VulnerabilitySummaryBucket, 0, len(sourceRows))
	for _, row := range sourceRows {
		bySource = append(bySource, &model.VulnerabilitySummaryBucket{
			Key:   row.Source,
			Count: row.Count,
		})
	}

	byStatus := make([]*model.VulnerabilitySummaryBucket, 0, len(statusRows))
	for _, row := range statusRows {
		byStatus = append(byStatus, &model.VulnerabilitySummaryBucket{
			Key:   row.Status,
			Count: row.Count,
		})
	}

	res := &model.VulnerabilitySummary{
		Total:      total,
		BySeverity: bySeverity,
		BySource:   bySource,
		ByStatus:   byStatus,
	}

	return res, nil
}
